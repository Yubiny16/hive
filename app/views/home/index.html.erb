<!-- Header -->
<nav class="navbar navbar-default navbar-fixed-top" id="navbar-custom">
  <div class="container-fluid">
    <div class="row">

      <div class="col-md-1">
      </div>

      <div class="col-md-2">
        <a class="navbar-brand" href="/home/index">H I V E</a>
      </div>

      <!--search bar-->
      <div class="col-md-4" style="padding-left: 0;">
        <form action="/home/search" method="get">
          <!-- Pass search words to controller -->
          <input id="search_group" name= "search_group" type="text" class="form-control" data-autocomplete= "<%= Group.order(:name).map(&:name) %>" placeholder="Search Your Group">
          <button type="submit" class="btn btn-search"><i class="fa fa-search" aria-hidden="true"></i></button>
        </form>
      </div>

      <div class="col-md-3">
        <button class="btn dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          <%= current_user.first_name %> <%= current_user.last_name%>
        </button>
        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
          <a href="/home/profile" class="dropdown-item">Edit Profile</a>
          <a href="/users/edit" class="dropdown-item">Setting</a>
          <a href="/users/sign_out" class="dropdown-item">Sign Out</a>
        </div>
      </div>

      <div class="col-md-2">
      </div>

    </div>
  </div>
</nav><!-- Header End -->

<!-- Body -->
<div class="container-fluid container-body">
  <div class="row">

    <div class="col-md-1">
    </div>

    <!-- Left Bar -->
    <div class="col-md-2 leftbar">
      <ul class="leftbar-personal">
        <li><a href="/home/index"><i class="fa fa-server" aria-hidden="true"></i>Board</a></li>
        <li><a href="/home/my_calendar"><i class="fa fa-calendar" aria-hidden="true"></i>Calendar</a></li>
      </ul>
      <hr>

      <ul class="leftbar-groups">
        <% unless @current_group_user == nil %>
          <% @current_group_user.each do |group_user| %>
            <li><div class="circle_<%= group_user.color %>"></div><a href="/home/group_page/<%= group_user.group_id %>"><%= Group.find(group_user.group_id).name %></a></li>
          <% end %>
        <% end %>
      </ul>
      <hr />
      <p><a href="/home/create_group_view"><i class="fa fa-plus-circle" aria-hidden="true"></i>Create Group</a></p>
    </div><!-- leftbar End-->

    <!-- Main/Board -->
    <div class="col-md-7 board" style="padding-left: 20px;">
      <!-- Announcement Feed -->
        <h4>NEWS FEED</h4>
        <div id="main_board">
          <ul class="nav nav-stacked">
            <% @all_notification.each do |all_notification| %>
              <% if all_notification.notification_type == 1 %>
                <% if all_notification.read == false %>
                  <li class="announcement_feed announcement_<%= all_notification.id %>">
                    <a href="#ann_<%= all_notification.id %>" data-toggle="tab">
                      <span class="circle_<%= @current_group_user.find_by(group_id: all_notification.group_id).color %>"></span>
                      <p class="announcement_list_title">
                        <span class="unread-notification unread-notification_<%= all_notification.id %>"></span><%= all_notification.title %>
                      </p>
                      <p class="announcement_list_date ">
                        <%= all_notification.created_at.strftime("%Y/%m/%d") %>
                      </p>
                      <span class="announcement_list_content">
                        <%= all_notification.content.html_safe %>
                      </span>
                    </a>
                  </li>

                  <script>
                  $(function() {
                    $('.announcement_<%= all_notification.id %>').click(function(){
                      var ann_notification_id = <%= all_notification.id %>;

                      $.ajax({
                        method: "GET",
                        url: '/home/ann_read',
                        data: { ann_notification_id: ann_notification_id }
                      }).done(function() {
                        //not read --> read
                        $('.unread-notification_<%= all_notification.id %>').hide();

                      });
                    });
                  });
                </script>

                <% else %><!-- read -->
                  <li class="announcement_feed announcement_<%= all_notification.id %>">
                    <a href="#ann_<%= all_notification.id %>" data-toggle="tab">
                      <span class="circle_<%= @current_group_user.find_by(group_id: all_notification.group_id).color %>"></span>
                      <p class="announcement_list_title">
                        <%= all_notification.title %>
                      </p>
                      <p class="announcement_list_date ">
                        <%= all_notification.created_at.strftime("%Y/%m/%d") %>
                      </p>
                      <span class="announcement_list_content">
                        <%= all_notification.content.html_safe %>
                      </span>
                    </a>
                  </li>
                <% end %>

              <% elsif all_notification.notification_type == 2 %>
                <% if all_notification.read == false %>
                  <li class="poll_feed poll_<%= all_notification.id %>">
                    <span class="circle_<%= @current_group_user.find_by(group_id: all_notification.group_id).color %>"></span>
                    <span class="unread-notification"></span>
                    <a href="#poll_<%= all_notification.id %>" data-toggle="tab">
                      <p class="poll_list_title">
                        <span class="unread-notification unread-notification_<%= all_notification.id %>"></span><%= all_notification.title %>
                      </p>
                      <p class="poll_list_date">
                        <%= all_notification.created_at.strftime("%Y-%m-%d") %>
                      </p>
                    </a>
                  </li>

                  <script>
                    $(function() {
                      $('.poll_<%= all_notification.id %>').click(function(){
                        var poll_notification_id = <%= all_notification.id %>;

                        $.ajax({
                          method: "GET",
                          url: '/home/poll_read',
                          data: { poll_notification_id: poll_notification_id }
                        }).done(function() {
                          $('.unread-notification_<%= all_notification.id %>').hide();
                        });
                      });
                    });
                  </script>

                <% else %><!-- unread -->
                  <li class="poll_feed poll_<%= all_notification.id %>">
                    <a href="#poll_<%= all_notification.id %>" data-toggle="tab">
                      <span class="circle_<%= @current_group_user.find_by(group_id: all_notification.group_id).color %>"></span>
                      <p class="poll_list_title">
                        <%= all_notification.title %>
                      </p>
                      <p class="poll_list_date">
                        <%= all_notification.created_at.strftime("%Y-%m-%d") %>
                      </p>
                    </a>
                  </li>
                <% end %>

              <% end %><!-- notification_type -->
            <% end %><!-- all_notification.each -->
          </ul>

          <div class="tab-content">
            <% @all_notification.each do |all_notification| %>
              <!-- Announcement Feed -->
              <% if all_notification.notification_type == 1 %>
                <div class="tab-pane" id="ann_<%= all_notification.id %>">
                  <h4><%= all_notification.title %></h4>
                  <p>From: <%= User.find(Annnoti.find_by(announcement_id: all_notification.announcement_id).sender).first_name %> <%= User.find(Annnoti.find_by(announcement_id: all_notification.announcement_id).sender).last_name %></p>
                  <span class="announcement_tab_content_date"><%= all_notification.created_at.strftime("%B %e, %Y at %l:%M %p") %></span>
                  <div class="announcement_tab_content_content"><%= sanitize(all_notification.content) %></div>
                </div>

              <!-- Poll Feed -->
              <% elsif all_notification.notification_type == 2 %>
                <div class="tab-pane" id="poll_<%= all_notification.id %>">
                  <h4><%= all_notification.title %></h4>
                  <p>From: <%= User.find(Pollnoti.find_by(poll_id: all_notification.poll_id).sender).first_name %> <span style="text-transform: capitalize"><%= User.find(Pollnoti.find_by(poll_id: all_notification.poll_id).sender).last_name %></span></p>
                  <span class="poll_tab_content_date"><%= all_notification.created_at.strftime("%B %e, %Y at %l:%M %p") %></span>
                  <!-- Already voted -->
                  <% if Polluser.where(user_id: @user.id).where(poll_id: all_notification.poll_id).where(voted: true).exists? %>
                    <div class="already-voted">
                      <form action="/home/option_cancel" method="get">
                        <% Option.where(poll_id: all_notification.poll_id).find_each do |o| %>
                          <div class="radio">
                            <!-- Options -->
                            <label><input type="radio" name="optradio" value="<%= o.id %>"><%= o.content %></label>
                          </div>
                        <% end %>
                        <!-- user cancels his/her vote -->
                        <button name="poll_id" value="<%= all_notification.id %>" type="submit" class="btn">Cancel My Vote</button>
                      </form>

                      <div class="poll_stat_<%= all_notification.id %>">
                        <% Option.where(poll_id: all_notification.poll_id).find_each do |o| %>
                          <p class="view_stat_options"><%= o.content %> <span style="color: #DA413D;"><%= o.vote_number %></span></p>
                          <!-- Find the people who voted -->
                          <% Polluser.where(option_id: o.id).where(voted: true).find_each do |pu| %>
                            <% User.where(id: pu.user_id).find_each do |voted_user| %>
                              <div class="view_stat_options_votes">
                                <%= voted_user.first_name %> <%= voted_user.last_name %>
                              </div>
                            <% end %>
                          <% end %>
                        <% end %>

                        <!-- Find the people who have not voted -->
                        <p class="view_stat_options">Not Voted</p>
                        <% GroupUser.where(group_id: all_notification.group_id).find_each do |gr| %>
                          <% User.where(id: gr.user_id).find_each do |not_voted_user| %>
                            <% if !Polluser.where(user_id: not_voted_user.id).where(poll_id: all_notification.poll_id).exists? %>
                              <div class="view_stat_options_votes">
                                <%= not_voted_user.first_name %> <%= not_voted_user.last_name %>
                              </div>
                            <% end %>
                            <% if Polluser.where(user_id: not_voted_user.id).where(poll_id: all_notification.poll_id).where(voted: false).exists? %>
                              <div class="view_stat_options_votes">
                                <%= not_voted_user.first_name %> <%= not_voted_user.last_name %>
                              </div>
                            <% end %>
                          <% end %>
                        <% end %>
                      </div><!-- poll_stat -->

                    </div>

                  <% else %><!-- Already voted? NO -->
                  <div class="not-voted">
                    <!-- then Vote -->
                    <form action="/home/option_select" method="get">
                      <% Option.where(poll_id: all_notification.poll_id).find_each do |o| %>
                        <div class="radio">
                          <!-- Options -->
                          <label><input type="radio" name="optradio" value="<%= o.id %>"><%= o.content %></label>
                        </div>
                      <% end %>
                      <button name="poll_id" value="<%= all_notification.id %>" type="submit" class="btn">Vote!</button>
                    </form><!-- Vote -->

                    <div class="poll_stat_<%= all_notification.id %>">
                      <% Option.where(poll_id: all_notification.poll_id).find_each do |o| %>
                        <p class="view_stat_options"><%= o.content %> <span style="color: #DA413D;"><%= o.vote_number %></span></p>
                        <!-- Find the people who voted -->
                        <% Polluser.where(option_id: o.id).where(voted: true).find_each do |pu| %>
                          <% User.where(id: pu.user_id).find_each do |voted_user| %>
                            <div class="view_stat_options_votes">
                              <%= voted_user.first_name %> <%= voted_user.last_name %>
                            </div>
                          <% end %>
                        <% end %>
                      <% end %>

                      <!-- Find the people who have not voted -->
                      <p class="view_stat_options">Not Voted</p>
                      <% GroupUser.where(group_id: all_notification.group_id).find_each do |gr| %>
                        <% User.where(id: gr.user_id).find_each do |not_voted_user| %>
                          <% if !Polluser.where(user_id: not_voted_user.id).where(poll_id: all_notification.poll_id).exists? %>
                            <div class="view_stat_options_votes">
                              <%= not_voted_user.first_name %> <%= not_voted_user.last_name %>
                            </div>
                          <% end %>
                          <% if Polluser.where(user_id: not_voted_user.id).where(poll_id: all_notification.poll_id).where(voted: false).exists? %>
                            <div class="view_stat_options_votes">
                              <%= not_voted_user.first_name %> <%= not_voted_user.last_name %>
                            </div>
                          <% end %>
                        <% end %>
                      <% end %>
                    </div><!-- poll_stat -->

                  </div>
                  <% end %><!-- Polluser exists? -->
                </div>
              <% end %>
            <% end %>
          </div>

          <script>
            $(function(){
              $('#main_board ul li:first-child').addClass("active");
              $('#main_board .tab-content .tab-pane:first-child').addClass("active");
            });
          </script>

        </div>

    </div><!--col-md-7-->

    <div class="col-md-2">
      <div class="filter-dropdown">
        <button class ="filter-dropdown-btn-feature">All</button>
        <div class="filter-dropdown-content">
          <p id="filter-all">All</p>
          <p id="filter-announcement">Announcement</p>
          <p id="filter-poll">Poll</p>
        </div>
      </div>
      <div class="filter-dropdown">
        <button class ="filter-dropdown-btn-group">All</button>
        <div class="filter-dropdown-content">
          <p id="filter-group-all">
            All
          </p>
          <% unless @current_group_user == nil %>
            <% @current_group_user.each do |group_user| %>
              <p id="filter-group-<%= group_user.group_id %>">
                <div class="circle_<%= group_user.color %>"></div><%= Group.find(group_user.group_id).name %>
              </p>
              <% @group_name = Group.find(group_user.group_id).name %>
              <script>
                //filter by group
                $( function() {
                  $("#filter-group-<%= group_user.group_id %>").click(function(){
                    $(".announcement_feed").hide();
                    $(".poll_feed").hide();
                    $(".announcement_<%= group_user.group_id %>").fadeIn();
                    $(".poll_<%= group_user.group_id %>").fadeIn();
                    $('.filter-dropdown-btn-group').html("<%= @group_name %>");
                 });
                 } );
              </script>
            <% end %>
          <% end %>
        </div>
      </div>
    </div><!-- row 2-->

  </div><!-- row -->
</div><!-- container-fluid container-body -->

<script>
//filer by feature
$( function() {
  $("#filter-announcement").click(function(){
     $(".poll_feed").hide();
     $(".announcement_feed").fadeIn();
     $('.filter-dropdown-btn-feature').html('Announcement');
 });
 } );

$( function() {
 $("#filter-poll").click(function(){
   $(".announcement_feed").hide();
    $(".poll_feed").fadeIn();
    $('.filter-dropdown-btn-feature').html('Poll');
});
} );

$( function() {
  $("#filter-all").click(function(){
    $(".announcement_feed").fadeIn();
     $(".poll_feed").fadeIn();
     $('.filter-dropdown-btn-feature').html('All');
 });
 } );
//filter by group (all)
$( function() {
  $("#filter-group-all").click(function(){
    $(".announcement_feed").fadeIn();
     $(".poll_feed").fadeIn();
     $('.filter-dropdown-btn-group').html('All');
 });
 } );
//search suggestions
$( function() {
  $( "#search_group" ).autocomplete({
    source: $( "#search_group" ).data('autocomplete')
  });
});

//add event button success message popup
$( function() {
  $(".add_event_button").click(function(){
     alert("You have successfully added the event to your calendar!");
 });
 } );
</script>

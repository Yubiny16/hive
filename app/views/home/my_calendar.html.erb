<!-- Welcome Message -->
<% if User.find_by_id(current_user.id).mycalendar_first_time == "yes" %>
  <script>
    jQuery(function(){
     jQuery('#welcome_message_btn').trigger('click');
    });
    var mycalendar_first_time = "no"

    $.ajax({
      method: "GET",
      url: '/home/my_calendar/',
      data: { mycalendar_first_time: mycalendar_first_time }
    })

  </script>
  <button id="welcome_message_btn" data-toggle="modal" data-target="#welcome_message" class="btn" type="hidden"></button>
  <div class="modal fade" id="welcome_message" tableindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
          <h4 class="modal-title" style="text-align: center;">This is Your Calendar!<i style="margin-left: 5px" class="fa fa-calendar" aria-hidden="true"></i></h4>
        </div>
        <div class="modal-body" style="text-align: center; font-size: 16px">

          Start your first "<span style="font-size: 16px; font-family: Source Sans Pro Bold; color: #DA413D;">SYNCED</span>" schedule!<br /><br />
          Balance multiple groups in one by adding different group events to your schedule! <br /><br />
          <%= image_tag("calendar-instruction.png", size: "300x200") %>


        </div>
        <div class="modal-footer get-started" style="text-align: center;">
          <button data-dismiss="modal">Got it!</button>
        </div>
      </div>
    </div>
  </div>
<% end %>
<!-- Header -->
<nav class="navbar navbar-default navbar-fixed-top" id="navbar-custom">
  <div class="container-fluid">
    <div class="row">

      <div class="col-md-2">
        <a class="navbar-brand" href="/home/index">H I V E</a>
      </div>

      <!--search bar-->
      <div class="col-md-5" style="padding-left: 0;">
        <form action="/home/search" method="get">
          <!-- Pass search words to controller -->
          <input id="search_group" name= "search_group" type="text" class="form-control" data-autocomplete= "<%= Group.order(:name).map(&:name) %>" placeholder="Search Your Group">
          <button type="submit" class="btn btn-search"><i class="fa fa-search" aria-hidden="true"></i></button>
        </form>
      </div>

      <div class="col-md-3">
        <button class="btn dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          <%= current_user.first_name %> <%= current_user.last_name%>
        </button>
        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
          <a href="/home/profile" class="dropdown-item">Edit Profile</a>
          <a href="/users/edit" class="dropdown-item">Setting</a>
          <a href="/users/sign_out" class="dropdown-item">Sign Out</a>
        </div>
      </div>

      <div class="col-md-2">
      </div>

    </div>
  </div>
</nav><!-- Header End -->


<!-- Body -->
<div class="container-fluid container-body">
  <div class="row">

    <!-- Left Bar -->
    <div class="col-md-2 leftbar">
      <ul class="leftbar-personal">
        <li><a href="/home/index"><i class="fa fa-tasks" aria-hidden="true"></i>Board</a></li>
        <li style="background-color: #DA413D;"><a href="/home/my_calendar" style="color: white"><i class="fa fa-calendar" aria-hidden="true"></i>My Schedule</a></li>
      </ul>
      <hr>

      <ul class="leftbar-groups">
        <% unless @current_group_user == nil %>
          <% @current_group_user.where.not(group_id: 1).each do |group_user| %>
            <li><div class="circle_<%= group_user.color %>"></div><a href="/home/group_page/<%= group_user.group_id %>"><%= Group.find(group_user.group_id).name %></a></li>
          <% end %>
        <% end %>
      </ul>
      <hr />
      <p><a href="/home/create_group_view"><i class="fa fa-plus-circle" aria-hidden="true"></i>Create Group</a></p>
    </div><!-- leftbar End-->

    <!-- Main/Board -->
    <div class="col-md-7 board">
      <div class="calendar" style="margin-left: 70px; margin-right: 50px">
        <div id="event_type" data-type="<%= $type %>"></div>
      </div>
    </div><!--col-md-7-->

    <!-- Calendar Feed -->
    <div class="col-md-3" style="background-color: white">

      <!-- Filter -->
      <div class="filter-dropdown calendar-filter-group">
        <button class ="calendar-filter-dropdown-btn-group">All</button>
        <div class="filter-dropdown-content">
          <p id="calendar-filter-group-all">
            All
          </p>
          <% unless @current_group_user == nil %>
            <% @current_group_user.where.not(group_id: 1).each do |group_user| %>
              <p id="calendar-filter-group-<%= group_user.group_id %>">
                <span class="circle_<%= group_user.color %>"></span>
              </p>

              <script>
                //filter by group
                $( function() {
                  $("#calendar-filter-group-<%= group_user.group_id %>").click(function(){

                    var group_color = "<%= group_user.color %>";
                    if (group_color == "red")
                    {
                      var change_color = "#e60000";
                    }
                    else if (group_color == "orange")
                    {
                      var change_color = "#ffa64d";
                    }
                    else if (group_color == "yellow")
                    {
                      var change_color = "#ffdb4d";
                    }
                    else if (group_color == "green")
                    {
                      var change_color = "#77b756";
                    }
                    else if (group_color == "blue")
                    {
                      var change_color = "#2f77c0";
                    }
                    else if (group_color == "skyblue")
                    {
                      var change_color = "#66d9ff";
                    }
                    else
                    {
                      var change_color = "#aa80ff";
                    }


                    $(".one_event").remove();
                    $('#calendar_board').append(event_group_<%= group_user.group_id %>);

                    if (rsvp_filter_switch == "Added")
                    {
                      $(".added_event").fadeIn();
                      $(".not_added_event").hide();
                    }
                    else if (rsvp_filter_switch == "Not Added")
                    {
                      $(".not_added_event").fadeIn();
                      $(".added_event").hide();
                    }
                    else
                    {
                      $(".added_event").fadeIn();
                      $(".not_added_event").fadeIn();
                    }

                    $('.calendar-filter-dropdown-btn-group').css("background-color", change_color);
                    $('.calendar-filter-dropdown-btn-group').css("color", change_color);
                    $('.calendar-filter-dropdown-btn-group').css("border-color", change_color);

                 });
                 } );
              </script>
            <% end %>
          <% end %>
        </div>
      </div>

      <div class="filter-dropdown calendar-filter-rsvp">
        <button class ="calendar-filter-dropdown-btn-rsvp">All</button>
        <div class="filter-dropdown-content">
          <p id="filter-all">All</p>
          <p id="filter-added">Added</p>
          <p id="filter-notadded">Not Added</p>
        </div>
      </div>

      <div id="calendar_board">
        <% unless @cal_notification.first == nil %>
          <% @cal_notification.each do |cal_notification| %>
            <% if !Event.where(event_id: cal_notification.event_id).where(calendar_type: 0).where(user_id: cal_notification.receiver).exists? %>
              <div class="one_event cal_<%= cal_notification.event_id %> event_group_<%= cal_notification.group_id %> not_added_event">
                <div class="rectangle_<%= @current_group_user.find_by(group_id: cal_notification.group_id).color %>"></div>
                <i class="event_not_added_icon fa fa-times" aria-hidden="true"></i>
                <p class="one_event_title">
                  <%= cal_notification.title %>
                </p>
                <p class="one_event_content">
                  <%= cal_notification.description %>
                </p>
                <p class="one_event_start">
                  <span style="color: #d4624c">Start:</span> <%= cal_notification.start.strftime("%B %e, %Y at %l:%M %p") %>
                </p>
                <p class="one_event_end">
                  <span style="color: #d4624c">End:</span> <%= cal_notification.end.strftime("%B %e, %Y at %l:%M %p") %>
                </p>
                <form action="/home/add_event" method="post">
                  <input name="title" type="hidden" value="<%= cal_notification.title %>"/>
                  <input name="start" type="hidden" value="<%= cal_notification.start %>"/>
                  <input name="end" type="hidden" value="<%= cal_notification.end%>"/>
                  <input name="description" type="hidden" value="<%= cal_notification.description %>"/>
                  <input name="group_id" type="hidden" value="<%= cal_notification.group_id %>"/>
                  <input name="event_id" type="hidden" value="<%= cal_notification.event_id %>"/>
                  <input name="color" type="hidden" value="<%= @current_group_user.find_by(group_id: cal_notification.group_id).color %>"/>
                  <button type="submit" class="btn add_event_button">Add to My Calendar</button>
                </form>

                <div class="view-attending-members view-toggle-<%= cal_notification.event_id %>">
                  View Attendance
                </div>
                <ol class="attending-members-<%= cal_notification.event_id %>">
                  <% Eventuser.where(event_id: cal_notification.event_id).each do |attending_members| %>
                    <li>
                      <%= User.find(attending_members.user_id).first_name %> <%= User.find(attending_members.user_id).last_name %>
                    </li>
                  <% end %>
                </ol>
                <script>
                  //view attendance toggle
                  $( ".attending-members-<%= cal_notification.event_id %>" ).hide();
                  $( ".view-toggle-<%= cal_notification.event_id %>" ).click(function() {
                    $( ".attending-members-<%= cal_notification.event_id %>" ).toggle(300, function() {
                      // Animation complete.
                    });
                  });
                </script>
              </div>
            <% else %>
              <div class="one_event cal_<%= cal_notification.event_id %> event_group_<%= cal_notification.group_id %> added_event">
                <div class="rectangle_<%= @current_group_user.find_by(group_id: cal_notification.group_id).color %>"></div>
                <i class="event_added_icon fa fa-check" style="color: green" aria-hidden="true"></i>
                <p class="one_event_title">
                  <%= cal_notification.title %>
                </p>
                <p class="one_event_content">
                  <%= cal_notification.description %>
                </p>
                <p class="one_event_start">
                  <span style="color: #d4624c">Start:</span> <%= cal_notification.start.strftime("%B %e, %Y at %l:%M %p") %>
                </p>
                <p class="one_event_end">
                  <span style="color: #d4624c">End:</span> <%= cal_notification.end.strftime("%B %e, %Y at %l:%M %p") %>
                </p>
                <form action="/home/cancel_event" method="get">
                  <input name="event_id" type="hidden" value="<%= cal_notification.event_id %>"/>
                  <button type="submit" class="btn add_event_button">Cancel</button>
                </form>

                <div class="view-attending-members view-toggle-<%= cal_notification.event_id %>">
                  View Attendance
                </div>
                <ol class="attending-members-<%= cal_notification.event_id %>">
                  <% Eventuser.where(event_id: cal_notification.event_id).each do |attending_members| %>
                    <li>
                      <%= User.find(attending_members.user_id).first_name %> <%= User.find(attending_members.user_id).last_name %>
                    </li>
                  <% end %>
                </ol>
              </div>

              <script>
                //view attendance toggle
                $( ".attending-members-<%= cal_notification.event_id %>" ).hide();
                $( ".view-toggle-<%= cal_notification.event_id %>" ).click(function() {
                  $( ".attending-members-<%= cal_notification.event_id %>" ).toggle(300, function() {
                    // Animation complete.
                  });
                });
              </script>
            <% end %>
          <% end %>
        <% else %>
          <div class="no-feed-message">
            <p>
              No Group Event
            </p>
          </div>
        <% end %>
      </div><!-- calendar_board -->
    </div><!-- col-md-3-->

  </div><!-- row -->
</div><!-- container-fluid container-body -->

<!-- Need for filter by group -->
<% @current_group_user.each do |group_user| %>
  <script>
    event_group_<%= group_user.group_id %> = $('.event_group_<%= group_user.group_id %>');
  </script>
<% end %>


<script>
//for multiple filtering
rsvp_filter_switch = "All";
all_feed = $('.one_event');

//filter by group (all)
$( function() {
  $("#calendar-filter-group-all").click(function(){

    $('#calendar_board').append(all_feed);

    if (rsvp_filter_switch == "Added")
    {
      $(".added_event").fadeIn();
      $(".not_added_event").hide();
    }
    else if (rsvp_filter_switch == "Not Added")
    {
      $(".not_added_event").fadeIn();
      $(".added_event").hide();
    }
    else
    {
      $(".added_event").fadeIn();
      $(".not_added_event").fadeIn();
    }

    $('.calendar-filter-dropdown-btn-group').css('background-color', "white");
    $('.calendar-filter-dropdown-btn-group').css('color', "#DA413D");
    $('.calendar-filter-dropdown-btn-group').css('border-color', "#DA413D");

 });
 } )

 //filer by rsvp status
 $( function() {
   $("#filter-added").click(function(){

     $(".not_added_event").hide();
     $(".added_event").fadeIn();
     $('.calendar-filter-dropdown-btn-rsvp').html('Added Events');
     rsvp_filter_switch = "Added";

  });
  } );

 $( function() {
  $("#filter-notadded").click(function(){

    $(".added_event").hide();
     $(".not_added_event").fadeIn();
     $('.calendar-filter-dropdown-btn-rsvp').html('Not Added Events');
     rsvp_filter_switch = "Not Added";

 });
 } );

 $( function() {
   $("#filter-all").click(function(){

     $(".added_event").fadeIn();
     $(".not_added_event").fadeIn();

     rsvp_filter_switch = "All";
     $('.calendar-filter-dropdown-btn-rsvp').html('All');

  });
  } );


// My Calendar
var initialize_calendar;

  initialize_calendar = function() {
    $('.calendar').each(function(){
      var calendar = $(this);

      calendar.fullCalendar({
        header: {
          left: 'prev, next, today',
          center: 'title',
          right: 'month, agendaWeek, agendaDay'
        },
        selectable: true,
        selectHelper: true,
        editable: true,
        eventLimit: true,
        droppable: true,
        events: '/events.json',
        select: function(start, end) {
          $.getScript('/events/new', function() {
            if (start.hasTime())
            {
              $('#event_date_range').val(moment(start).format("MM/DD/YYYY HH:mm") + ' - ' + moment(end).format("MM/DD/YYYY HH:mm"));
              $('.start_hidden').val(moment(start).format('YYYY-MM-DD HH:mm'));
              $('.end_hidden').val(moment(end).format('YYYY-MM-DD HH:mm'));
            }
            else {
              $('#event_date_range').val(moment(start).format("MM/DD/YYYY") + ' - ' + moment(end).format("MM/DD/YYYY"));
              $('.start_hidden').val(moment(start).format('YYYY-MM-DD'));
              $('.end_hidden').val(moment(end).format('YYYY-MM-DD'));
            }
          });

          calendar.fullCalendar('unselect');
        },

        eventDrop: function(event, delta, revertFunc) {
        event_data = {
          event: {
            id: event.id,
            start: event.start.format(),
            end: event.end.format()
          }
        };
        $.ajax({
              url: event.update_url,
              data: event_data,
              type: 'PATCH'
          });
        },

        eventClick: function(event, jsEvent, view) {
          if(event.event_type == 0)
          {
            $.getScript(event.edit_url, function() {
              $('#event_date_range').val(moment(event.start).format("MM/DD/YYYY HH:mm") + ' - ' + moment(event.end).format("MM/DD/YYYY HH:mm"));
              date_range_picker();
              $('.start_hidden').val(moment(event.start).format('YYYY-MM-DD HH:mm'));
              $('.end_hidden').val(moment(event.end).format('YYYY-MM-DD HH:mm'));
            });
          }
          else
          {
            $('.one_event').remove();
            $('#calendar_board').append(all_feed);
            $('.one_event').hide();
            $(".cal_" + event.event_id).fadeIn();
            rsvp_filter_switch = "All";

            $('.calendar-filter-dropdown-btn-group').css('background-color', "#DA413D");
            $('.calendar-filter-dropdown-btn-group').css('color', "#DA413D");
            $('.calendar-filter-dropdown-btn-rsvp').css('color', "#DA413D");

          }

       }
      });
    });
  };
$(document).on('turbolinks:load', initialize_calendar);
</script>
